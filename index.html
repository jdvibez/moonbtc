<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moon ☾ + BTC ₿ Tracker</title>
  <meta name="description" content="Live Bitcoin price with 7-day chart + current Moon phase and time to next phases." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f8f9fa; 
      --card:#ffffff; 
      --muted:#6c757d; 
      --accent:#007bff; 
      --danger:#dc3545; 
      --ok:#28a745; 
      --text:#212529;
      --ring: rgba(0,123,255,.25);
      --shadow: 0 4px 12px rgba(0,0,0,.08);
      --radius: 0px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      font-family: 'IBM Plex Mono', monospace;
      background: var(--bg);
      color:var(--text);
    }
    header{padding:28px 20px 8px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .brand .logo{
      width:40px; height:40px; display:grid; place-items:center; border-radius:var(--radius);
      background: linear-gradient(135deg,#1f2937, #0ea5e9 60%, #22d3ee);
      color: white;
      box-shadow: var(--shadow);
      font-size:20px;
    }
    .sub{color:var(--muted); font-weight:500}
    main{padding:16px 20px 40px; max-width:1200px; margin:0 auto}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background: var(--card);
      border:1px solid #dee2e6;
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 12px; font-size:18px}
    .muted{color:var(--muted)}
    .price{
      font-size:40px; font-weight:700; letter-spacing:-.5px; line-height:1.1;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .chip{
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #ced4da;
      background: #f8f9fa;
    }
    .chip.ok{border-color: rgba(40,167,69,.35); color:var(--ok); background:rgba(40,167,69,.1)}
    .chip.bad{border-color: rgba(220,53,69,.35); color:var(--danger); background:rgba(220,53,69,.1)}
    .mini{font-size:12px}
    .controls{margin-top:10px; display:flex; gap:8px; align-items:center}
    button{
      background:#f1f3f6; color:var(--text); border:1px solid #ced4da;
      padding:8px 10px; border-radius:var(--radius); font:inherit; cursor:pointer;
    }
    
    /* Improved Moon Visualization */
    .moon-wrap{display:flex; gap:18px; align-items:center; flex-wrap:wrap}
    .moon{
      width:120px; height:120px; border-radius:50%; position:relative;
      background:#1a1a1a; 
      box-shadow: 0 0 20px rgba(0,0,0,0.3), inset -5px -5px 15px rgba(0,0,0,.4);
      overflow:hidden; border:2px solid #333; flex-shrink:0;
    }
    
    /* Moon surface with craters */
    .moon::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: 
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.1) 2px, transparent 3px),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,0.08) 1px, transparent 2px),
        radial-gradient(circle at 20% 70%, rgba(0,0,0,0.2) 3px, transparent 4px),
        radial-gradient(circle at 80% 80%, rgba(0,0,0,0.15) 2px, transparent 3px);
    }
    
    .moon .lit{
      position:absolute; inset:0; border-radius:50%;
      background: linear-gradient(90deg, 
        #e8e8e8 0%, 
        #d4d4d4 20%, 
        #c0c0c0 40%, 
        #b8b8b8 60%, 
        #a8a8a8 80%, 
        #999 100%);
      opacity: 1;
    }
    
    .phase-grid{display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr));}
    .kpi{padding:10px; border-radius:var(--radius); background:#f8f9fa; border:1px solid #e9ecef}
    .kpi b{display:block; font-size:13px; color:var(--muted)}
    .kpi span{font-weight:700; font-size:16px}
    .trading-signal .chip {font-size: 16px; padding: 10px 16px; font-weight: 700;}
    footer{color:var(--muted); padding:18px 20px 40px; text-align:center; font-size:12px}
    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    
    .chart-container {
        flex-grow: 1;
        margin-top: 12px;
    }
    
    .donation-addresses {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    .address-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .address-row label {
      font-weight: 700;
      flex-basis: 50px;
      flex-shrink: 0;
    }
    .address-row input[type="text"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      background-color: #f8f9fa;
      font-family: 'IBM Plex Mono', monospace;
      color: var(--muted);
      border-radius: var(--radius);
      font-size: 14px;
      min-width: 100px;
    }
    
    /* Layout placements */
    .col-7{grid-column: span 7}
    .col-5{grid-column: span 5}
    .col-12{grid-column: span 12}
    
    /* Pandora Chatbot Widget Styles */
    .chatbot-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .chat-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1f2937, #0ea5e9 60%, #22d3ee);
      border: none;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-family: 'IBM Plex Mono', monospace;
    }
    
    .chat-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .chat-iframe-container {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 380px;
      height: 600px;
      background: var(--card);
      border: 1px solid #dee2e6;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transform: translateY(20px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .chat-iframe-container.open {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }
    
    .chat-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: var(--radius);
    }
    
    .close-chat {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border: 1px solid #ced4da;
      background: #f1f3f6;
      color: var(--text);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      z-index: 1001;
      transition: background-color 0.2s ease;
      font-family: 'IBM Plex Mono', monospace;
    }
    
    .close-chat:hover {
      background: #e9ecef;
    }
    
    @media (max-width: 920px){
      .col-7,.col-5{grid-column: span 12}
      .chart-container {
        height: 450px;
        flex-grow: 0;
      }
    }
    
    @media (max-width: 480px) {
  .chat-iframe-container {
    /* Set the width and height as intended */
    width: calc(100vw - 40px);
    height: 70vh;

    /* Unset inherited horizontal positioning */
    right: auto;
    left: 50%;
    
    /* Pull the element back by half its own width to center it */
    transform: translateX(-50%);
  }
}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">☾₿</div>
      <div>
        <div>Moon + BTC Tracker</div>
        <div class="sub">Live Bitcoin price · Lunar phases · Trading Signals</div>
      </div>
    </div>
    <div class="sub" id="clock">—</div>
  </header>

  <main>
    <section class="grid">
      <!-- BTC PRICE CARD -->
      <article class="card col-7" aria-live="polite" style="display: flex; flex-direction: column;">
        <div>
          <div style="display:flex; justify-content:space-between; align-items:start; flex-wrap:wrap; gap:10px;">
            <div>
              <h2>Bitcoin Price</h2>
              <div class="price" id="price-usd">—</div>
            </div>
            <div style="text-align:right">
              <div class="muted mini" id="price-eur">—</div>
              <div class="chip mini" id="change" style="margin-top:4px">24h: —</div>
            </div>
          </div>
          <div class="controls">
            <button id="refresh">Refresh</button>
            <span class="mini muted" id="updated">Updated —</span>
          </div>
        </div>
        <div class="chart-container">
          <div class="tradingview-widget-container" style="height:100%">
            <div id="tradingview_chart" style="height:100%"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
            new TradingView.widget(
            {
              "autosize": true,
              "symbol": "BITSTAMP:BTCUSD",
              "interval": "D",
              "timezone": "Etc/UTC",
              "theme": "light",
              "style": "1",
              "locale": "en",
              "toolbar_bg": "#f1f3f6",
              "enable_publishing": false,
              "hide_side_toolbar": false,
              "allow_symbol_change": true,
              "container_id": "tradingview_chart"
            }
            );
            </script>
          </div>
        </div>
      </article>

      <!-- RIGHT COLUMN CARDS -->
      <div class="col-5" style="display:flex; flex-direction:column; gap:16px;">
        <!-- MOON PHASE CARD -->
        <article class="card">
          <h2>Moon Phase</h2>
          <div class="moon-wrap">
            <div class="moon" aria-hidden="true">
              <div class="lit" id="lit"></div>
            </div>
            <div>
              <div class="row" style="gap:8px">
                <span class="chip" id="phase-name">—</span>
                <span class="chip" id="illum">—% lit</span>
                <span class="chip" id="age">Age: — d</span>
              </div>
              <div class="phase-grid" style="margin-top:10px">
                <div class="kpi"><b>→ First Quarter</b><span id="to-fq">—</span></div>
                <div class="kpi"><b>→ Full Moon</b><span id="to-full">—</span></div>
                <div class="kpi"><b>→ Last Quarter</b><span id="to-lq">—</span></div>
                <div class="kpi"><b>→ New Moon</b><span id="to-new">—</span></div>
              </div>
            </div>
          </div>
        </article>

        <!-- TRADING SIGNALS CARD -->
        <article class="card">
          <h2>Lunar Trading Signal</h2>
          <div class="trading-signal" style="display:flex; flex-direction:column; gap:12px; align-items:stretch">
             <div class="chip" id="signal-chip" style="align-self: flex-start;">—</div>
             <div class="kpi"><b>Next Buy Window Begins</b><span id="next-buy">—</span></div>
             <div class="kpi"><b>Next Sell Window Begins</b><span id="next-sell">—</span></div>
          </div>
        </article>
        
        <!-- FEAR & GREED INDEX CARD -->
        <article class="card">
          <h2>Market Sentiment</h2>
          <div>
            <a href="https://alternative.me/crypto/fear-and-greed-index/" target="_blank" rel="noopener noreferrer">
              <img src="https://alternative.me/crypto/fear-and-greed-index.png" alt="Crypto Fear & Greed Index" style="width: 100%; max-width: 350px; margin: auto; display: block;">
            </a>
          </div>
        </article>
      </div>

      <!-- DONATIONS CARD -->
      <article class="card col-12">
        <h2>Support This Project</h2>
        <p class="muted mini" style="margin-top:-8px; margin-bottom:12px;">If you find this tool useful, consider a donation to help keep it running.</p>
        <div class="donation-addresses">
          <div class="address-row">
            <label for="btc-address">BTC</label>
            <input type="text" id="btc-address" value="bc1qrk8z9rq9ppvez60le2apx7nx03225rgkggvcgk" readonly>
            <button onclick="copyAddress(this, 'btc-address')">Copy</button>
          </div>
          <div class="address-row">
            <label for="evm-address">EVM</label>
            <input type="text" id="evm-address" value="0xCC10D05CcAA609E0cfc83b6418dE33De3918ED4b" readonly>
            <button onclick="copyAddress(this, 'evm-address')">Copy</button>
          </div>
          <div class="address-row">
            <label for="sol-address">SOL</label>
            <input type="text" id="sol-address" value="8QC5aSUWaf18szvTf27Jkd18oicwxApe12NkvErD6v5c" readonly>
            <button onclick="copyAddress(this, 'sol-address')">Copy</button>
          </div>
        </div>
      </article>

      <article class="card col-12">
        <p class="muted mini">
          • Price data provided by CoinGecko (fallback to CryptoCompare). Chart by TradingView. <br>
          • Moon calculations are based on a standard synodic cycle. Signals are for entertainment purposes only and do not constitute financial advice.
        </p>
      </article>
    </section>
  </main>

  <footer>
    Built for fun by <a href="https://x.com/saulrugman" target="_blank" rel="noopener noreferrer">@saulrugman</a>, not financial advice. © <span id="year"></span>
  </footer>

  <!-- Pandora Chatbot Widget -->
  <div class="chatbot-widget">
    <div class="chat-iframe-container" id="chatContainer">
      <button class="close-chat" id="closeChat">×</button>
      <iframe 
        class="chat-iframe" 
        src=""
        title="Pandora Chatbot - Your Snarky AI Guide to Lunar Trading"
        id="chatIframe">
      </iframe>
    </div>
    <button class="chat-toggle" id="chatToggle">☾💬</button>
  </div>

  <script>
    // ---------- Utilities ----------
    const fmt = (n, c='USD') => new Intl.NumberFormat(undefined, {style:'currency', currency:c}).format(n);
    const fmtDec = (n, d=2)=> (Math.round(n*10**d)/10**d).toFixed(d);

    const daysHours = (x) => {
      const days = Math.floor(x);
      const hrs = Math.round((x - days) * 24);
      return (days > 0 ? `${days}d ` : '') + `${hrs}h`;
    };

    const formatCountdown = (daysDecimal) => {
      let totalSeconds = daysDecimal * 24 * 60 * 60;
      
      const days = Math.floor(totalSeconds / 86400);
      totalSeconds %= 86400;
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);

      const pad = (num) => String(num).padStart(2, '0');

      return `${days}d ${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
    };

    function setClock(){
      document.getElementById('clock').textContent = new Date().toLocaleString(undefined, { dateStyle:'full', timeStyle:'medium' });
    }
    setInterval(setClock, 1000); 
    setClock();
    document.getElementById('year').textContent = new Date().getFullYear();

    function copyAddress(button, inputId) {
      const input = document.getElementById(inputId);
      input.select();
      input.setSelectionRange(0, 99999);

      try {
        document.execCommand('copy');
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy. Please copy the address manually.');
      }
    }

    // ---------- BTC PRICE ----------
    const el = {
      priceUSD: document.getElementById('price-usd'),
      priceEUR: document.getElementById('price-eur'),
      change: document.getElementById('change'),
      updated: document.getElementById('updated'),
      refresh: document.getElementById('refresh')
    };

    async function fetchBTCPrice(){
      try{
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,eur&include_24hr_change=true');
        if (!r.ok) throw new Error('CoinGecko API failed');
        const data = await r.json();
        return {
          usd: data.bitcoin.usd,
          eur: data.bitcoin.eur,
          change: data.bitcoin.usd_24h_change
        };
      } catch(e) {
        console.warn("CoinGecko failed, using fallback. Error:", e);
        const r2 = await fetch('https://min-api.cryptocompare.com/data/price?fsym=BTC&tsyms=USD,EUR');
        const data2 = await r2.json();
        return { usd: data2.USD, eur: data2.EUR, change: NaN };
      }
    }

    function updatePriceUI({usd, eur, change}){
      el.priceUSD.textContent = fmt(usd, 'USD');
      el.priceEUR.textContent = fmt(eur, 'EUR');
      if(Number.isFinite(change)){
        const s = (change >= 0 ? '+' : '') + fmtDec(change, 2) + '%';
        el.change.textContent = '24h: ' + s;
        el.change.className = 'chip mini ' + (change >= 0 ? 'ok' : 'bad');
      } else {
        el.change.textContent = '24h: —';
        el.change.className = 'chip mini';
      }
      el.updated.textContent = 'Updated ' + new Date().toLocaleTimeString();
    }

    // ---------- IMPROVED MOON & TRADING SIGNALS ----------
    const SYNODIC = 29.530588853; // days
    const EPOCH = Date.UTC(2000, 0, 6, 18, 14, 0);

    const mEl = {
      lit: document.getElementById('lit'),
      name: document.getElementById('phase-name'),
      illum: document.getElementById('illum'),
      age: document.getElementById('age'),
      toFQ: document.getElementById('to-fq'),
      toFull: document.getElementById('to-full'),
      toLQ: document.getElementById('to-lq'),
      toNew: document.getElementById('to-new'),
      signalChip: document.getElementById('signal-chip'),
      nextBuy: document.getElementById('next-buy'),
      nextSell: document.getElementById('next-sell')
    };

    function moonData(date = new Date()){
      const days = (date.getTime() - EPOCH) / 86400000;
      const age = ((days % SYNODIC) + SYNODIC) % SYNODIC;
      const illum = (1 - Math.cos(2 * Math.PI * (age / SYNODIC))) / 2;

      const phaseEdges = [0, 1.84566, 5.53699, 9.22831, 12.91963, 16.61096, 20.30228, 23.99361, 27.68493, SYNODIC];
      const phaseNames = ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent", "New Moon"];
      let phaseName = phaseNames[phaseNames.length - 1];
      for(let i=0; i < phaseEdges.length - 1; i++){
        if(age >= phaseEdges[i] && age < phaseEdges[i+1]){ phaseName = phaseNames[i]; break; }
      }

      const timeTo = (target) => {
        let diff = target - age;
        if (diff < 0) diff += SYNODIC;
        return diff;
      };
      
      return {
        age, illum, phaseName,
        toNew: timeTo(SYNODIC),
        toFQ: timeTo(SYNODIC / 4),
        toFull: timeTo(SYNODIC / 2),
        toLQ: timeTo(3 * SYNODIC / 4)
      };
    }
    
    function createMoonShape(phase, illumination) {
      if (illumination < 0.01) {
        return 'circle(0% at center)';
      } else if (illumination > 0.99) {
        return 'circle(50% at center)';
      } else if (phase < 0.5) {
        const terminator = 50 - (illumination * 50);
        return `ellipse(50% ${terminator}% at center)`;
      } else {
        const terminator = (illumination * 50);
        return `ellipse(50% ${terminator}% at center)`;
      }
    }
    
    function updateMoonAndSignalUI(){
      const d = moonData();

      // Moon UI
      mEl.name.textContent = d.phaseName;
      mEl.illum.textContent = `${fmtDec(d.illum * 100, 1)}% lit`;
      mEl.age.textContent = `Age: ${fmtDec(d.age, 1)} d`;
      mEl.toFQ.textContent = daysHours(d.toFQ);
      mEl.toFull.textContent = daysHours(d.toFull);
      mEl.toLQ.textContent = daysHours(d.toLQ);
      mEl.toNew.textContent = daysHours(d.toNew);

      // Moon visualization
      const phase = d.age / SYNODIC;
      const clipPath = createMoonShape(phase, d.illum);
      mEl.lit.style.clipPath = clipPath;

      if (phase > 0.5) {
        mEl.lit.style.transform = 'scaleX(-1)';
      } else {
        mEl.lit.style.transform = 'scaleX(1)';
      }

      // Signal UI
      const isWaxing = d.age < (SYNODIC / 2);
      if (isWaxing) {
        mEl.signalChip.textContent = 'BUY & HOLD';
        mEl.signalChip.className = 'chip ok';
      } else {
        mEl.signalChip.textContent = 'SELL & TAKE PROFIT';
        mEl.signalChip.className = 'chip bad';
      }
      mEl.nextBuy.textContent = formatCountdown(d.toNew);
      mEl.nextSell.textContent = formatCountdown(d.toFull);
    }

    // ---------- Main Functions ----------
    async function refreshAll(){
      try {
        const price = await fetchBTCPrice();
        updatePriceUI(price);
      } catch (e) {
        console.error("Could not fetch price data:", e);
        el.priceUSD.textContent = 'Error';
      }
      updateMoonAndSignalUI();
    }

    // ---------- Event Listeners ----------
    el.refresh.addEventListener('click', refreshAll);
    setInterval(updateMoonAndSignalUI, 1000);
    setInterval(refreshAll, 90 * 1000);

    // ---------- PANDORA CHATBOT WIDGET ----------
    const chatToggle = document.getElementById('chatToggle');
    const chatContainer = document.getElementById('chatContainer');
    const closeChat = document.getElementById('closeChat');
    const chatIframe = document.getElementById('chatIframe');
    
    let isChatOpen = false;
    let isChatLoaded = false;
    
    chatToggle.addEventListener('click', function() {
      if (!isChatOpen) {
        chatContainer.classList.add('open');
        chatToggle.style.transform = 'rotate(180deg)';
        isChatOpen = true;
        
        if (!isChatLoaded) {
          chatIframe.src = 'https://pandoramoon.vercel.app/';
          isChatLoaded = true;
        }
      } else {
        chatContainer.classList.remove('open');
        chatToggle.style.transform = 'rotate(0deg)';
        isChatOpen = false;
      }
    });
    
    closeChat.addEventListener('click', function() {
      chatContainer.classList.remove('open');
      chatToggle.style.transform = 'rotate(0deg)';
      isChatOpen = false;
    });
    
    document.addEventListener('click', function(e) {
      if (isChatOpen && !chatContainer.contains(e.target) && e.target !== chatToggle) {
        chatContainer.classList.remove('open');
        chatToggle.style.transform = 'rotate(0deg)';
        isChatOpen = false;
      }
    });
    
    chatIframe.addEventListener('load', function() {
      console.log('Pandora chatbot loaded successfully');
    });
    
    chatIframe.addEventListener('error', function() {
      console.error('Failed to load Pandora chatbot');
      chatContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted); font-family: inherit;">Failed to load Pandora. Please try again later.</div>';
    });

    // ---------- Initialize ----------
    window.addEventListener('load', refreshAll);
  </script>
</body>
</html>
