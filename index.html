<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moon ☾ + BTC ₿ Tracker</title>
  <meta name="description" content="Live Bitcoin price with 7-day chart + current Moon phase and time to next phases." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f8f9fa; 
      --card:#ffffff; 
      --muted:#6c757d; 
      --accent:#007bff; 
      --danger:#dc3545; 
      --ok:#28a745; 
      --text:#212529;
      --ring: rgba(0,123,255,.25);
      --shadow: 0 4px 12px rgba(0,0,0,.08);
      --radius: 0px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      font-family: 'IBM Plex Mono', monospace;
      background: var(--bg);
      color:var(--text);
    }
    header{padding:28px 20px 8px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .brand .logo{
      width:40px; height:40px; display:grid; place-items:center; border-radius:var(--radius);
      background: linear-gradient(135deg,#1f2937, #0ea5e9 60%, #22d3ee);
      color: white;
      box-shadow: var(--shadow);
      font-size:20px;
    }
    .sub{color:var(--muted); font-weight:500}
    main{padding:16px 20px 40px; max-width:1200px; margin:0 auto}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      background: var(--card);
      border:1px solid #dee2e6;
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 12px; font-size:18px}
    .muted{color:var(--muted)}
    .price {
        font-size: 40px;
        font-weight: 700;
        letter-spacing: -0.5px;
        line-height: 1.1;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .chip{
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #ced4da;
      background: #f8f9fa;
    }
    .chip.ok{border-color: rgba(40,167,69,.35); color:var(--ok); background:rgba(40,167,69,.1)}
    .chip.bad{border-color: rgba(220,53,69,.35); color:var(--danger); background:rgba(220,53,69,.1)}
    .mini{font-size:12px}
    button{
      background:#f1f3f6; color:var(--text); border:1px solid #ced4da;
      padding:8px 10px; border-radius:var(--radius); font:inherit; cursor:pointer;
    }
    /* Moon */
    .moon-wrap{display:flex; gap:18px; align-items:center; flex-wrap:wrap}
    .moon{
      width:120px; height:120px; border-radius:50%; position:relative;
      background:#0a0a0a; box-shadow: inset -12px -12px 26px rgba(0,0,0,.65), inset 8px 8px 24px rgba(255,255,255,.08);
      overflow:hidden; border:1px solid #dee2e6; flex-shrink:0;
    }
    .moon .lit{
      position:absolute; inset:0; border-radius:50%;
      background: radial-gradient(100% 100% at 50% 50%, #d1e9ff 0%, #bcd7ff 35%, #9fbce6 55%, #7c98bf 75%, #657a98 100%);
      mix-blend-mode: screen; opacity:.95;
    }
    .moon .shadow{
      position:absolute; inset:-10% 0 -10% 0; border-radius:50%;
      background: radial-gradient(100% 100% at 50% 50%, rgba(0,0,0,.0) 40%, rgba(0,0,0,.5) 70%, rgba(0,0,0,.85) 100%);
      pointer-events:none;
    }
    .phase-grid{display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr));}
    .kpi{padding:10px; border-radius:var(--radius); background:#f8f9fa; border:1px solid #e9ecef}
    .kpi b{display:block; font-size:13px; color:var(--muted)}
    .kpi span{font-weight:700; font-size:16px}
    .trading-signal .chip {font-size: 16px; padding: 10px 16px; font-weight: 700;}
    footer{color:var(--muted); padding:18px 20px 40px; text-align:center; font-size:12px}
    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    
    .chart-container {
        flex-grow: 1;
        margin-top: 16px;
    }
    
    .donation-addresses {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    .address-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .address-row label {
      font-weight: 700;
      flex-basis: 50px;
      flex-shrink: 0;
    }
    .address-row input[type="text"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      background-color: #f8f9fa;
      font-family: 'IBM Plex Mono', monospace;
      color: var(--muted);
      border-radius: var(--radius);
      font-size: 14px;
      min-width: 100px;
    }
    
    /* Layout placements */
    .col-7{grid-column: span 7}
    .col-5{grid-column: span 5}
    .col-12{grid-column: span 12}
    
    @media (max-width: 920px){
      .col-7,.col-5{grid-column: span 12}
      .chart-container {
        height: 450px; /* Set fixed height for chart on mobile */
        flex-grow: 0;
      }
    }
  </style>
  
  <!-- SEO Schema Markup -->
  <script type="application/ld+json" id="app-schema">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Moon + BTC Tracker",
    "description": "A real-time dashboard tracking the price of Bitcoin (BTC) alongside lunar phases, providing speculative trading signals based on the moon's cycle.",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "mainEntity": {
      "@type": "FinancialProduct",
      "name": "Bitcoin",
      "tickerSymbol": "BTC",
      "offers": {
        "@type": "Offer",
        "price": "0.00",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
      }
    },
    "subjectOf": {
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What are the data sources for this tracker?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Price data is provided by CoinGecko with a fallback to CryptoCompare. The interactive chart is provided by TradingView. Moon calculations are computed based on a standard synodic cycle."
          }
        },
        {
          "@type": "Question",
          "name": "Is the Lunar Trading Signal financial advice?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "No. The lunar signals are for entertainment and educational purposes only and do not constitute financial advice. All financial decisions should be made with care and consultation with a qualified professional."
          }
        }
      ]
    }
  }
  </script>

</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">☾₿</div>
      <div>
        <div data-translate="app_title">Moon + BTC Tracker</div>
        <div class="sub" data-translate="app_subtitle">Live Bitcoin price · Lunar phases · Trading Signals</div>
      </div>
    </div>
    <div class="sub" id="clock">—</div>
  </header>

  <main>
    <section class="grid">
      <!-- BTC PRICE CARD -->
      <article class="card col-7" aria-live="polite" style="display: flex; flex-direction: column;">
        <h2 data-translate="btc_price_title">Bitcoin Price</h2>
        
        <div class="row" style="justify-content:space-between">
            <div>
                <div class="price" id="price">—</div>
                <div class="row mini" style="margin-top:6px">
                    <span class="chip" id="change" data-translate-prefix="change_24h">24h: —</span>
                </div>
            </div>
            <div style="text-align: right;">
                <div class="mini muted" id="updated"></div>
                <button id="refresh" data-translate="refresh_btn" style="margin-top: 4px;">Refresh</button>
            </div>
        </div>

        <div class="chart-container">
          <!-- TradingView Widget is initialized in JS to set language -->
          <div class="tradingview-widget-container" style="height:100%">
            <div id="tradingview_chart" style="height:100%"></div>
          </div>
        </div>
      </article>

      <!-- RIGHT COLUMN CARDS -->
      <div class="col-5" style="display:flex; flex-direction:column; gap:16px;">
        <!-- MOON PHASE CARD -->
        <article class="card">
          <h2 data-translate="moon_phase_title">Moon Phase</h2>
          <div class="moon-wrap">
            <div class="moon" aria-hidden="true">
              <div class="lit" id="lit"></div>
              <div class="shadow"></div>
            </div>
            <div>
              <div class="row" style="gap:8px">
                <span class="chip" id="phase-name">—</span>
                <span class="chip" id="illum">—</span>
                <span class="chip" id="age">—</span>
              </div>
              <div class="phase-grid" style="margin-top:10px">
                <div class="kpi"><b data-translate="to_fq">→ First Quarter</b><span id="to-fq">—</span></div>
                <div class="kpi"><b data-translate="to_full">→ Full Moon</b><span id="to-full">—</span></div>
                <div class="kpi"><b data-translate="to_lq">→ Last Quarter</b><span id="to-lq">—</span></div>
                <div class="kpi"><b data-translate="to_new">→ New Moon</b><span id="to-new">—</span></div>
              </div>
            </div>
          </div>
        </article>

        <!-- TRADING SIGNALS CARD -->
        <article class="card">
          <h2 data-translate="signal_title">Lunar Trading Signal</h2>
          <div class="trading-signal" style="display:flex; flex-direction:column; gap:12px; align-items:stretch">
             <div class="chip" id="signal-chip" style="align-self: flex-start;">—</div>
             <div class="kpi"><b data-translate="next_buy_window">Next Buy Window Begins</b><span id="next-buy">—</span></div>
             <div class="kpi"><b data-translate="next_sell_window">Next Sell Window Begins</b><span id="next-sell">—</span></div>
          </div>
        </article>
        
        <!-- FEAR & GREED INDEX CARD -->
        <article class="card">
          <h2 data-translate="sentiment_title">Market Sentiment</h2>
          <div>
            <a href="https://alternative.me/crypto/fear-and-greed-index/" target="_blank" rel="noopener noreferrer">
              <img src="https://alternative.me/crypto/fear-and-greed-index.png" alt="Crypto Fear & Greed Index" style="width: 100%; max-width: 350px; margin: auto; display: block;">
            </a>
          </div>
        </article>
      </div>

      <!-- DONATIONS CARD -->
      <article class="card col-12">
        <h2 data-translate="support_title">Support This Project</h2>
        <p class="muted mini" style="margin-top:-8px; margin-bottom:12px;" data-translate="support_subtitle">If you find this tool useful, consider a donation to help keep it running.</p>
        <div class="donation-addresses">
          <div class="address-row">
            <label for="btc-address">BTC</label>
            <input type="text" id="btc-address" value="bc1qrk8z9rq9ppvez60le2apx7nx03225rgkggvcgk" readonly>
            <button data-translate-copy="copy" onclick="copyAddress(this, 'btc-address')">Copy</button>
          </div>
          <div class="address-row">
            <label for="evm-address">EVM</label>
            <input type="text" id="evm-address" value="0xCC10D05CcAA609E0cfc83b6418dE33De3918ED4b" readonly>
            <button data-translate-copy="copy" onclick="copyAddress(this, 'evm-address')">Copy</button>
          </div>
          <div class="address-row">
            <label for="sol-address">SOL</label>
            <input type="text" id="sol-address" value="8QC5aSUWaf18szvTf27Jkd18oicwxApe12NkvErD6v5c" readonly>
            <button data-translate-copy="copy" onclick="copyAddress(this, 'sol-address')">Copy</button>
          </div>
        </div>
      </article>

      <article class="card col-12">
        <p class="muted mini" data-translate="notes_text">
          • Price data provided by CoinGecko (fallback to CryptoCompare). Chart by TradingView. <br>
          • Moon calculations are based on a standard synodic cycle. Signals are for entertainment purposes only and do not constitute financial advice.
        </p>
      </article>
    </section>
  </main>

  <footer>
    <span data-translate="footer_text">Built for fun by</span> <a href="https://x.com/saulrugman" target="_blank" rel="noopener noreferrer">@saulrugman</a>, <span data-translate="footer_disclaimer">not financial advice</span>. © <span id="year"></span>
  </footer>

  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    const translations = {
      en: {
        app_title: "Moon + BTC Tracker",
        app_subtitle: "Live Bitcoin price · Lunar phases · Trading Signals",
        btc_price_title: "Bitcoin Price",
        moon_phase_title: "Moon Phase",
        to_fq: "→ First Quarter",
        to_full: "→ Full Moon",
        to_lq: "→ Last Quarter",
        to_new: "→ New Moon",
        signal_title: "Lunar Trading Signal",
        next_buy_window: "Next Buy Window Begins",
        next_sell_window: "Next Sell Window Begins",
        sentiment_title: "Market Sentiment",
        support_title: "Support This Project",
        support_subtitle: "If you find this tool useful, consider a donation to help keep it running.",
        copy: "Copy",
        copied: "Copied!",
        notes_text: "• Price data provided by CoinGecko (fallback to CryptoCompare). Chart by TradingView. <br> • Moon calculations are based on a standard synodic cycle. Signals are for entertainment purposes only and do not constitute financial advice.",
        footer_text: "Built for fun by",
        footer_disclaimer: "not financial advice",
        change_24h: "24h:",
        updated: "Updated",
        refresh_btn: "Refresh",
        // Dynamic content
        phaseNames: ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent", "New Moon"],
        illum_lit: "% lit",
        age_days: "Age: {age} d",
        signal_buy: "BUY & HOLD",
        signal_sell: "SELL & TAKE PROFIT",
        // SEO Schema
        schema_desc: "A real-time dashboard tracking the price of Bitcoin (BTC) alongside lunar phases, providing speculative trading signals based on the moon's cycle.",
        schema_q1_name: "What are the data sources for this tracker?",
        schema_q1_answer: "Price data is provided by CoinGecko with a fallback to CryptoCompare. The interactive chart is provided by TradingView. Moon calculations are computed based on a standard synodic cycle.",
        schema_q2_name: "Is the Lunar Trading Signal financial advice?",
        schema_q2_answer: "No. The lunar signals are for entertainment and educational purposes only and do not constitute financial advice. All financial decisions should be made with care and consultation with a qualified professional."
      },
      es: {
        app_title: "Tracker Luna + BTC",
        app_subtitle: "Precio de Bitcoin en vivo · Fases lunares · Señales de Trading",
        btc_price_title: "Precio de Bitcoin",
        moon_phase_title: "Fase Lunar",
        to_fq: "→ Cuarto Creciente",
        to_full: "→ Luna Llena",
        to_lq: "→ Cuarto Menguante",
        to_new: "→ Luna Nueva",
        signal_title: "Señal de Trading Lunar",
        next_buy_window: "Próxima Ventana de Compra",
        next_sell_window: "Próxima Ventana de Venta",
        sentiment_title: "Sentimiento del Mercado",
        support_title: "Apoya este Proyecto",
        support_subtitle: "Si esta herramienta te resulta útil, considera hacer una donación para mantenerla en funcionamiento.",
        copy: "Copiar",
        copied: "¡Copiado!",
        notes_text: "• Datos de precios de CoinGecko (con respaldo de CryptoCompare). Gráfico de TradingView. <br> • Los cálculos lunares se basan en un ciclo sinódico estándar. Las señales son solo para fines de entretenimiento y no constituyen asesoramiento financiero.",
        footer_text: "Creado por diversión por",
        footer_disclaimer: "no es asesoramiento financiero",
        change_24h: "24h:",
        updated: "Actualizado",
        refresh_btn: "Refrescar",
        // Dynamic content
        phaseNames: ["Luna Nueva", "Creciente Iluminante", "Cuarto Creciente", "Gibosa Iluminante", "Luna Llena", "Gibosa Menguante", "Cuarto Menguante", "Creciente Menguante", "Luna Nueva"],
        illum_lit: "% iluminada",
        age_days: "Edad: {age} d",
        signal_buy: "COMPRAR Y MANTENER",
        signal_sell: "VENDER Y TOMAR GANANCIAS",
        // SEO Schema
        schema_desc: "Un dashboard en tiempo real que sigue el precio de Bitcoin (BTC) junto con las fases lunares, proporcionando señales de trading especulativas basadas en el ciclo de la luna.",
        schema_q1_name: "¿Cuáles son las fuentes de datos para este tracker?",
        schema_q1_answer: "Los datos de precios son proporcionados por CoinGecko con respaldo de CryptoCompare. El gráfico interactivo es de TradingView. Los cálculos lunares se computan basados en un ciclo sinódico estándar.",
        schema_q2_name: "¿La Señal de Trading Lunar es asesoramiento financiero?",
        schema_q2_answer: "No. Las señales lunares son para fines de entretenimiento y educativos solamente y no constituyen asesoramiento financiero. Todas las decisiones financieras deben tomarse con cuidado y consultando a un profesional calificado."
      }
    };
    
    const lang = navigator.language.startsWith('es') ? 'es' : 'en';
    const T = translations[lang];

    function setLanguage() {
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.dataset.translate;
        if (T[key]) {
          el.innerHTML = T[key];
        }
      });
       document.querySelectorAll('[data-translate-copy]').forEach(el => {
        const key = el.dataset.translateCopy;
        if (T[key]) {
          el.textContent = T[key];
        }
      });
      document.querySelectorAll('[data-translate-prefix]').forEach(el => {
        const key = el.dataset.translatePrefix;
        const currentText = el.textContent.split(': ')[1] || '—';
         if (T[key]) {
          el.textContent = `${T[key]} ${currentText}`;
        }
      });
    }

    function updateSchema() {
      try {
        const schemaElement = document.getElementById('app-schema');
        const schemaData = JSON.parse(schemaElement.textContent);
        
        schemaData.name = T.app_title;
        schemaData.description = T.schema_desc;
        schemaData.subjectOf.mainEntity[0].name = T.schema_q1_name;
        schemaData.subjectOf.mainEntity[0].acceptedAnswer.text = T.schema_q1_answer;
        schemaData.subjectOf.mainEntity[1].name = T.schema_q2_name;
        schemaData.subjectOf.mainEntity[1].acceptedAnswer.text = T.schema_q2_answer;
        
        schemaElement.textContent = JSON.stringify(schemaData, null, 2);
      } catch(e) {
        console.error("Failed to update schema:", e);
      }
    }

    // ---------- Utilities ----------
    const fmtDec = (n, d=2)=> (Math.round(n*10**d)/10**d).toFixed(d);
    const fmt = (n, c = 'USD') => new Intl.NumberFormat(lang, { style: 'currency', currency: c, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);

    const formatCountdown = (daysDecimal) => {
      let totalSeconds = daysDecimal * 24 * 60 * 60;
      const days = Math.floor(totalSeconds / 86400);
      totalSeconds %= 86400;
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = Math.floor(totalSeconds % 60);
      const pad = (num) => String(num).padStart(2, '0');
      return `${days}d ${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
    };

    function setClock(){
      document.getElementById('clock').textContent = new Date().toLocaleString(lang, { dateStyle:'full', timeStyle:'medium' });
    }
    
    document.getElementById('year').textContent = new Date().getFullYear();

    function copyAddress(button, inputId) {
      const input = document.getElementById(inputId);
      input.select();
      input.setSelectionRange(0, 99999); 
      try {
        document.execCommand('copy');
        button.textContent = T.copied;
        setTimeout(() => { button.textContent = T.copy; }, 2000);
      } catch (err) {
        console.error('Failed to copy text: ', err);
      }
    }

    const el = {
        price: document.getElementById('price'),
        change: document.getElementById('change'),
        updated: document.getElementById('updated'),
        refresh: document.getElementById('refresh'),
    };

    async function fetchBTCPrice() {
        try {
            const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,eur&include_24hr_change=true');
            if (!r.ok) throw new Error('API fetch failed');
            const data = await r.json();
            updatePriceUI(data.bitcoin);
            updateSchemaPrice(data.bitcoin.usd);
        } catch (e) {
            console.error("Could not fetch price data:", e);
            el.price.textContent = 'Error';
        }
    }

    function updatePriceUI({ usd, usd_24h_change }) {
        el.price.textContent = fmt(usd, 'USD');
        const change = parseFloat(usd_24h_change);
        if (Number.isFinite(change)) {
            const s = (change >= 0 ? '+' : '') + fmtDec(change, 2) + '%';
            el.change.textContent = `${T.change_24h} ${s}`;
            el.change.classList.remove('ok', 'bad');
            el.change.classList.add(change >= 0 ? 'ok' : 'bad');
        } else {
            el.change.textContent = `${T.change_24h} —`;
            el.change.classList.remove('ok', 'bad');
        }
        el.updated.textContent = `${T.updated} ${new Date().toLocaleTimeString(lang)}`;
    }


    async function updateSchemaPrice(price) {
      try{
        const schemaElement = document.getElementById('app-schema');
        const schemaData = JSON.parse(schemaElement.textContent);
        schemaData.mainEntity.offers.price = price.toFixed(2);
        schemaElement.textContent = JSON.stringify(schemaData, null, 2);
      } catch (e) {
        console.error("Failed to update schema price:", e);
      }
    }

    // ---------- MOON & TRADING SIGNALS ----------
    const SYNODIC = 29.530588853; 
    const EPOCH = Date.UTC(2000, 0, 6, 18, 14, 0);

    const mEl = {
      lit: document.getElementById('lit'),
      name: document.getElementById('phase-name'),
      illum: document.getElementById('illum'),
      age: document.getElementById('age'),
      toFQ: document.getElementById('to-fq'),
      toFull: document.getElementById('to-full'),
      toLQ: document.getElementById('to-lq'),
      toNew: document.getElementById('to-new'),
      signalChip: document.getElementById('signal-chip'),
      nextBuy: document.getElementById('next-buy'),
      nextSell: document.getElementById('next-sell')
    };

    function moonData(date = new Date()){
      const days = (date.getTime() - EPOCH) / 86400000;
      const age = ((days % SYNODIC) + SYNODIC) % SYNODIC;
      const illum = (1 - Math.cos(2 * Math.PI * (age / SYNODIC))) / 2;

      const phaseEdges = [0, 1.84566, 5.53699, 9.22831, 12.91963, 16.61096, 20.30228, 23.99361, 27.68493, SYNODIC];
      let phaseIndex = phaseEdges.length - 1;
      for(let i=0; i < phaseEdges.length - 1; i++){
        if(age >= phaseEdges[i] && age < phaseEdges[i+1]){ phaseIndex = i; break; }
      }

      const timeTo = (target) => {
        let diff = target - age;
        if (diff < 0) diff += SYNODIC;
        return diff;
      };
      
      return {
        age, illum, phaseIndex,
        toNew: timeTo(SYNODIC),
        toFQ: timeTo(SYNODIC / 4),
        toFull: timeTo(SYNODIC / 2),
        toLQ: timeTo(3 * SYNODIC / 4)
      };
    }
    
    function updateMoonAndSignalUI(){
      const d = moonData();
      
      const daysHours = (x) => {
        const days = Math.floor(x);
        const hrs = Math.round((x - days) * 24);
        return (days > 0 ? `${days}d ` : '') + `${hrs}h`;
      };

      mEl.name.textContent = T.phaseNames[d.phaseIndex];
      mEl.illum.textContent = `${fmtDec(d.illum * 100, 1)} ${T.illum_lit}`;
      mEl.age.textContent = T.age_days.replace('{age}', fmtDec(d.age, 1));
      mEl.toFQ.textContent = daysHours(d.toFQ);
      mEl.toFull.textContent = daysHours(d.toFull);
      mEl.toLQ.textContent = daysHours(d.toLQ);
      mEl.toNew.textContent = daysHours(d.toNew);

      const xShift = -Math.cos(2 * Math.PI * (d.age / SYNODIC)) * 48;
      mEl.lit.style.transform = `translateX(${xShift}%)`;

      const isWaxing = d.age < (SYNODIC / 2);
      if (isWaxing) {
        mEl.signalChip.textContent = T.signal_buy;
        mEl.signalChip.className = 'chip ok';
        mEl.signalChip.style.alignSelf = 'flex-start';
      } else {
        mEl.signalChip.textContent = T.signal_sell;
        mEl.signalChip.className = 'chip bad';
        mEl.signalChip.style.alignSelf = 'flex-start';
      }
      mEl.nextBuy.textContent = formatCountdown(d.toNew);
      mEl.nextSell.textContent = formatCountdown(d.toFull);
    }
    
    function initializeTradingViewWidget() {
        new TradingView.widget({
          "autosize": true,
          "symbol": "BITSTAMP:BTCUSD",
          "interval": "D",
          "timezone": "Etc/UTC",
          "theme": "light",
          "style": "1",
          "locale": lang,
          "toolbar_bg": "#f1f3f6",
          "enable_publishing": false,
          "hide_side_toolbar": false,
          "allow_symbol_change": true,
          "container_id": "tradingview_chart"
        });
    }

    async function refreshAll() {
        await fetchBTCPrice();
    }

    // ---------- Boot ----------
    function initialize(){
      setLanguage();
      updateSchema();
      initializeTradingViewWidget();
      updateMoonAndSignalUI();
      refreshAll();
      setClock();
      
      setInterval(setClock, 1000);
      setInterval(updateMoonAndSignalUI, 1000);
      setInterval(fetchBTCPrice, 90000); // refresh price every 90s
      
      el.refresh.addEventListener('click', refreshAll);
    }

    window.addEventListener('load', initialize);
  </script>
</body>
</html>

